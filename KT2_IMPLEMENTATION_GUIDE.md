# The Koppeltaal 2.0 implementation Guide

[begrippenlijst]

## Introduction
The Koppeltaal 2.0 implementation guide provides a guide for engineers, architects and product owners. This guide attempts to explain in what to expect when implementing Koppeltaal 2.0 in a high over fashion.


## Scope and domain
Depending on your application architecture, you must be aware that Koppeltaal 2.0 is deployed in the context of a domain. In case of a multi-tenant solution, you must be aware of the fact that most of the things you need will be domain specific and the architecture you choose must cater for this. If you are starting your application architecture from scratch you might want to consider a deployment-per-domain strategy and simplify your application architecture. However, such e per-domain deployment strategy might hinder the replication of content between installations. 


## Security and permission model

### Trust model
Koppeltaal uses a *application* level trust model, so applications get a role with a set of permissions that give access to FHIR resources. In Koppeltaal 2.0, the individual user of the system are NOT identified, it is the responsibility of the application to enforce user level restrictions. Applications are assigned roles, Koppeltaal 2.0 uses a form of Role-Based Access Control (RBAC). 
The trust model is based on a central authority in the Koppeltaal 2.0 domain, the authorization service, to which all access related tasks are delegated to. The authorization service hands out access to the API, validates launches and provides token introspection. 


#### Key pairs and secrecy
In order to participate in a domain, an application needs to generate a keypair and publish the public part by JWKS. The secret leg of the keypair must be kept secret. If the private part is leaked, others can easily take over your application role in the domain. By making use of JWKS it is make possible to have multiple key pairs active and change key pairs with minimal effort. It is advised to not store and share the private keys, instead to keep the private part in memory and disseminate the public part by JWKS.
#### Public key sharing
The public keys should be published by providing a JWKS URL to the Koppeltaal 2.0 domain. This URL contains a list of public keys identified by Key ID's (kid). These Key ID's must match the kid header of the JWTs that are generated by the application to identify itself. This JWKS URL is a way of publishing the verifications methods of the application. The URL must be public accessible. It is discouraged to use a common or well-known URL path for this URL.

Standards and specifications involved:
* [JSON Web Key (JWK)](https://datatracker.ietf.org/doc/html/rfc7517)
#### Roles & permissions
Applications in a domain get assigned a role by the domain administrator. This role is built up out of permissions to resources. These permissions are expressed in <resource-type>.<action>.<scope> format.
1. Resource: linked to a FHIR resource type.
2. Action: a set if Create (C), Read (R), Update (U) of Delete (D) actions.
3. Scope: one of the following:
   * OWN: access your own resources.
   * GRANTED: a list of applications
   * ALL: all resources.
The "ownership" of a resource is defined by the resource-origin extension field. This field refers to the Device of the owning application. 
#### Delegated trust
The authorization service plays a central role in the trust infrastructure of Koppeltaal 2.0. The authorization service provided access_tokens to the FHIR Rest API, validates the launch with SMART on FHIR app launch and token introspection.

Standards and specifications involved:
* [FHIR R4 Rest API](https://hl7.org/fhir/R4/http.html)


## Koppeltaal 2.0 Data model
The Koppeltaal 2.0 profile is published in the [Koppeltaal 2.0 Simplifier profile](https://simplifier.net/koppeltaalv2.0). 

| Resource Type      | Profile               | Usage                                                                                                                                                                                                                                                 |
|--------------------|-----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Organization       | KT_Organization       | A healthcare institution, location or department.                                                                                                                                                                                                     |
| Device             | KT_Device             | An Application Instance. This resource is created by the Administration Portal when a connection request for an Application in the Domain is approved. At that time, the ClientId is also assigned. This resource cannot be modified by applications. |
| ActivityDefinition | KT_ActivityDefinition | Describes an eHealth Module that can be assigned to a patient.                                                                                                                                                                                        |
| Patient            | KT_Patient            | Represents the patient.                                                                                                                                                                                                                               |
| CareTeam           | KT_CareTeam           | Represents a Care Team. That can be patient specific                                                                                                                                                                                                  |
| Practitioner       | KT_Practitioner       | Represents the practitioner.                                                                                                                                                                                                                          |
| Task               | KT_Task               | A Task is created each time a ActivityDefinition is assigned to a Patient. The task has a status that tracks the lifecycle of the task.                                                                                                               |
| Endpoint           | KT_Endpoint           | An endpoint describes the URL for the ActivityDefinition by the [KT2EndpointExtension](https://simplifier.net/koppeltaalv2.0/kt2endpointextension).                                                                                                   |
| Subscription       | KT_Subscription       | A subscription to notifications about changes to a particular resource type.                                                                                                                                                                          |
| AuditEvent         | KT_AuditEvent         | Is created for every relevant event in a Connecting Language Domain, such as the creation or modification of a resource instance, the opening or being opened of an eHealth Module via a launch.                                                      |
	



## Accessing the API
The Koppeltaal 2.0 Rest API can be accessed with an access_token. This token must be acquired by executing the SMART on FHIR backend services flow. This flow consists of a token request that validates the applications's identity and enforces the configured role for the application. The access_token consists of a JWT that contains the information the FHIR Rest API needs to apply the access rules that are in effect for the application.

Standards and specifications involved:
* [SMART on FHIR backend services](https://build.fhir.org/ig/HL7/smart-app-launch/backend-services.html)

### Getting access: generating a JWT to identify yourself
The SMART on FHIR backend services flow is in the core a OAuth2 client credential flow, that makes use of [JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants](https://www.rfc-editor.org/rfc/rfc7523) as client credential method. This means that the application needs to:
1. Generate a key pair that is used for signing the JWT.
2. Publish the public key in an URL known to the Koppeltaal 2.0 domain.
3. Sign a JWT as client credential with a kid header matching at least one key in the JWKS file published at 2). 
4. The client credential is provided as part of the token request, the field `client_assertion_type` is set to `urn:ietf:params:oauth:client-assertion-type:jwt-bearer` and the JWT is provided as `client_assertion.

Standards and specifications involved:
* [SMART on FHIR backend services](https://build.fhir.org/ig/HL7/smart-app-launch/backend-services.html)
* [JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants](https://www.rfc-editor.org/rfc/rfc7523)
* [OAuth 2.0 Client Credentials Grant](https://datatracker.ietf.org/doc/html/rfc6749#section-4.4)

### CRUD operations & versioning
Koppeltaal makes use if the [FHIR R4 Rest API](https://hl7.org/fhir/R4/http.html) as much as possible, with exception to the following:
* The update method requires a `If-Match` header.
* Conditional creates, conditional updates and conditional deletes MAY be supported by the FHIR resource service.
* Patching and conditional patching is not supported.
* Deletes are discouraged, lifecycle should be managed through status.
* Searching does not support the `_include`, `_revinclude`, `_contained` and `_containedType` parameters.

Standards and specifications involved:
[FHIR R4 Rest API](https://hl7.org/fhir/R4/http.html)

### Lifecycle entities
The lifecycle of entities are managed by either the `active` field or the `status` field of the entity.

| Resource Type | Profile | Usage                                                   |
|---------------|---------|---------------------------------------------------------|
| Organization  | active  | true, The organization's record is in active use.       |
|               |         | false, The organization's record is not in active use.  |
| Device        | status  |                                                         |
| Patient       | active  |                                                         |
| CareTeam      | status  |                                                         |
| Practitioner  | active  |                                                         |
| Task          | status  |                                                         |
| Endpoint      | status  |                                                         |
| Subscription  | status  |                                                         |


#### Deletion
Explains soft vs hard delete & expunge (MAY)
#### Handling errors and logging
Explain how the logging works and how errors should be logged.

## Get notified on changes
### Subscriptions
### Logging and tracing headers

## Launching
### Executing a launch
### Receiving a launch
### Logging and tracing


## The implementation checklist

1. Generate and securely retain public/private keypairs
2. Be able publish the public keys in a JWKS endpoint
3. Develop the logic to generate a JWT to identify your application to the auth service.
4. Request an access_token to access the API.
5. Be able to work with FHIR entities
6. Understand the lifecycle of FHIR entities
7. Subscriptions & notifications
7. Synchronization and errors
8. Staring a launch: generating a JWT
9. Receiving a launch: execute the SMART on FHIR sequence.



